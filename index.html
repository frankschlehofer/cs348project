<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS 348 Project Demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f9f9f9; }
        h1, h2 { color: #333; }
        input, select, button { padding: 8px; margin: 5px; font-size: 1em; border-radius: 4px; border: 1px solid #ccc; }
        button { cursor: pointer; background-color: #007bff; color: white; border: none; }
        button.edit { background-color: #ffc107; }
        button.delete { background-color: #dc3545; }
        #product-form, #filter-section, #inventory-adjust-form { background-color: #fff; border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #fff; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; }
        #form-title { color: #007bff; }
    </style>
</head>
<body>

    <h1>Product Inventory Manager</h1>

    <form id="category-form">
        <h2>Add New Category</h2>
        <div>
            <input type="text" id="category-name" placeholder="New Category Name" required>
            <button type="submit">Add Category</button>
        </div>
    </form>

    <form id="product-form">
        <h2 id="form-title">Add New Product</h2>
        <input type="hidden" id="product-id">
        <div>
            <input type="text" id="product-name" placeholder="Product Name" required>
            <input type="number" id="product-price" placeholder="Price" step="0.01" required>
            <input type="number" id="product-quantity" placeholder="Quantity" required>
            
            <select id="product-category" required>
                <option value="">Select a Category...</option>
            </select>
        </div>
        <button type="submit" id="submit-button">Add Product</button>
        <button type="button" id="cancel-edit" style="display:none;">Cancel</button>
    </form>

    <h2>Inventory Management</h2>
    <form id="inventory-adjust-form">
        <p>Simulate an atomic transfer of stock quantity between two products. Both updates must succeed, or both must fail (rollback).</p>
        <div>
            <select id="from-product-dropdown" required>
                <option value="">Transfer Stock FROM...</option>
            </select>
            <select id="to-product-dropdown" required>
                <option value="">Transfer Stock TO...</option>
            </select>
            <input type="number" id="transfer-quantity" placeholder="Transfer Quantity" required min="1">
            <button type="submit">Transfer Stock (Atomic)</button>
        </div>
        <p id="transaction-status" style="margin-top: 10px; font-weight: bold;"></p>
    </form>
    <h2>Product Report</h2>
    <div id="filter-section">
        <strong>Filter Report:</strong>
        <input type="number" id="min-price" placeholder="Min Price">
        <input type="number" id="max-price" placeholder="Max Price">
        <input type="number" id="min-qty" placeholder="Min Quantity">
        <input type="number" id="max-qty" placeholder="Max Quantity">
        <button id="filter-button">Apply Filter</button>
        <button id="clear-filter-button">Clear Filter</button>
    </div>

    <table id="products-table">
        <thead>
            <tr>
                <th>ID</th> 
                <th>Name</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Category</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="products-tbody">
            </tbody>
    </table>

    <script>
        const API_URL = 'http://localhost:3000/api';

        // DOM elements
        const form = document.getElementById('product-form');
        const formTitle = document.getElementById('form-title');
        const submitButton = document.getElementById('submit-button');
        const cancelEditButton = document.getElementById('cancel-edit');
        const categoryDropdown = document.getElementById('product-category');
        const productsTbody = document.getElementById('products-tbody');
        const categoryForm = document.getElementById('category-form');
        
        
        // Form inputs
        const hiddenId = document.getElementById('product-id');
        const nameInput = document.getElementById('product-name');
        const priceInput = document.getElementById('product-price');
        const quantityInput = document.getElementById('product-quantity');
        const categoryNameInput = document.getElementById('category-name');

        // Filter inputs
        const filterButton = document.getElementById('filter-button');
        const clearFilterButton = document.getElementById('clear-filter-button');
        const minPriceInput = document.getElementById('min-price');
        const maxPriceInput = document.getElementById('max-price');
        const minQtyInput = document.getElementById('min-qty');
        const maxQtyInput = document.getElementById('max-qty');
        
        // âœ¨ NEW: DOM elements for transaction form
        const adjustForm = document.getElementById('inventory-adjust-form');
        const fromProductDropdown = document.getElementById('from-product-dropdown');
        const toProductDropdown = document.getElementById('to-product-dropdown');
        const transferQuantityInput = document.getElementById('transfer-quantity');
        const transactionStatus = document.getElementById('transaction-status');


        // Build Dynamic UI (Categories)
        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}/categories`);
                const categories = await response.json();
                
                // Clear all options except the first "Select..." one
                categoryDropdown.innerHTML = '<option value="">Select a Category...</option>';
                
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.category_id;
                    option.textContent = cat.category_name;
                    categoryDropdown.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        async function loadProductDropdowns() {
            try {
                // Fetch all products
                const response = await fetch(`${API_URL}/products`);
                const products = await response.json();
                
                // Reset dropdowns
                fromProductDropdown.innerHTML = '<option value="">Transfer Stock FROM...</option>';
                toProductDropdown.innerHTML = '<option value="">Transfer Stock TO...</option>';

                products.forEach(product => {
                    // Create option for the "FROM" dropdown
                    const fromOption = document.createElement('option');
                    fromOption.value = product.product_id;
                    fromOption.textContent = `ID ${product.product_id}: ${product.product_name} (Qty: ${product.stock_quantity})`;
                    fromProductDropdown.appendChild(fromOption);

                    // Create option for the "TO" dropdown
                    const toOption = document.createElement('option');
                    toOption.value = product.product_id;
                    toOption.textContent = `ID ${product.product_id}: ${product.product_name} (Qty: ${product.stock_quantity})`;
                    toProductDropdown.appendChild(toOption);
                });
            } catch (error) {
                console.error('Error loading product dropdowns:', error);
            }
        }


        // Display Report (with Filtering)
        async function loadProducts(filters = {}) {
            const queryParams = new URLSearchParams(filters);
            const queryString = queryParams.toString();
            
            try {
                const response = await fetch(`${API_URL}/products?${queryString}`);
                const products = await response.json();
                
                // Clear the table body
                productsTbody.innerHTML = '';
                
                if (products.length === 0) {
                    productsTbody.innerHTML = '<tr><td colspan="6">No products found.</td></tr>';
                    return;
                }

                products.forEach(product => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${product.product_id}</td> <td>${product.product_name}</td>
                        <td>$${product.price.toFixed(2)}</td>
                        <td>${product.stock_quantity}</td>
                        <td>${product.category_name}</td>
                        <td>
                            <button class="edit" onclick="prepUpdateForm(${product.product_id}, '${product.product_name}', ${product.price}, ${product.stock_quantity}, ${product.category_id})">Edit</button>
                            <button class="delete" onclick="deleteProduct(${product.product_id})">Delete</button>
                        </td>
                    `;
                    productsTbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }
        
        // Event Listeners for Filtering
        filterButton.addEventListener('click', () => {
            const filters = {
                minPrice: minPriceInput.value,
                maxPrice: maxPriceInput.value,
                minQty: minQtyInput.value,
                maxQty: maxQtyInput.value,
            };
            // Remove empty filters
            Object.keys(filters).forEach(key => (filters[key] === '') && delete filters[key]);
            
            loadProducts(filters);
        });

        clearFilterButton.addEventListener('click', () => {
            minPriceInput.value = '';
            maxPriceInput.value = '';
            minQtyInput.value = '';
            maxQtyInput.value = '';
            loadProducts(); // Load all products
        });


        // Insert, Update, Delete

        // Form Submit (Handles both INSERT and UPDATE) for products
        form.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            
            const id = hiddenId.value;
            const productData = {
                name: nameInput.value,
                price: parseFloat(priceInput.value),
                quantity: parseInt(quantityInput.value),
                category_id: parseInt(categoryDropdown.value)
            };

            try {
                if (id) {
                    // UPDATE 
                    await fetch(`${API_URL}/products/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData)
                    });
                } else {
                    // INSERT 
                    await fetch(`${API_URL}/products`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData)
                    });
                }
                
                resetForm();
                loadProducts(); 
                loadProductDropdowns(); // Refresh transaction dropdowns
                
            } catch (error) {
                console.error('Error saving product:', error);
            }
        });

        // Insert new category
        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const categoryName = categoryNameInput.value;

            if (!categoryName) return;

            try {
                const response = await fetch(`${API_URL}/categories`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: categoryName })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || 'Failed to add category');
                }

                categoryNameInput.value = '';
                loadCategories(); 
                alert('Category added successfully!');

            } catch (error) {
                console.error('Error adding category:', error);
                alert(error.message);
            }
        });

        // DELETE
        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }
            try {
                await fetch(`${API_URL}/products/${id}`, {
                    method: 'DELETE'
                });
                loadProducts(); 
                loadProductDropdowns();
            } catch (error) {
                console.error('Error deleting product:', error);
            }
        }
        
        // Helper function to set up the form for an UPDATE 
        function prepUpdateForm(id, name, price, quantity, categoryId) {
            formTitle.textContent = 'Edit Product';
            hiddenId.value = id;
            nameInput.value = name;
            priceInput.value = price;
            quantityInput.value = quantity;
            categoryDropdown.value = categoryId;
            submitButton.textContent = 'Update Product';
            cancelEditButton.style.display = 'inline-block';
            window.scrollTo(0, 0); // Scroll to top
        }

        // Helper function to reset the form
        function resetForm() {
            formTitle.textContent = 'Add New Product';
            hiddenId.value = '';
            form.reset();
            submitButton.textContent = 'Add Product';
            cancelEditButton.style.display = 'none';
        }
        cancelEditButton.addEventListener('click', resetForm);
        
        adjustForm.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            
            // Clear previous status message
            transactionStatus.textContent = '';
            transactionStatus.style.color = 'black';

            const transferData = {
                // Get ID from the SELECTED OPTION's VALUE
                from_product_id: parseInt(fromProductDropdown.value),
                to_product_id: parseInt(toProductDropdown.value),
                quantity: parseInt(transferQuantityInput.value)
            };
            
            // Basic validation to prevent transferring to/from the same product
            if (transferData.from_product_id === transferData.to_product_id) {
                transactionStatus.textContent = 'Transaction Failed: Cannot transfer stock to the same product.';
                transactionStatus.style.color = 'red';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/inventory/adjust`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(transferData)
                });

                const result = await response.json();

                if (response.ok) {
                    transactionStatus.textContent = result.message + " The table below has been refreshed. (See updated quantities).";
                    transactionStatus.style.color = 'green';
                    loadProducts(); 
                    loadProductDropdowns();
                } else {
                    transactionStatus.textContent = `Transaction Failed (ROLLBACK): ${result.message || 'Server error'}`;
                    transactionStatus.style.color = 'red';
                }
                
                // Clear inputs on completion/failure
                transferQuantityInput.value = '';

            } catch (error) {
                console.error('Error during transaction:', error);
                transactionStatus.textContent = 'An unexpected network error occurred during the transfer.';
                transactionStatus.style.color = 'red';
            }
        });


        // Initial Page Load
        document.addEventListener('DOMContentLoaded', () => {
            loadCategories(); 
            loadProducts(); 
            loadProductDropdowns();
        });

    </script>
</body>
</html>